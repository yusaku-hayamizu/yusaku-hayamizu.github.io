#author("2022-03-31T05:20:33+00:00","","")
[[Program]]

* KVM [#w30f4373]

[[Kernel-based Virtual Machine (KVM)::https://www.linux-kvm.org/page/Main_Page]] converts Linux to hypervisor, where virtual machines are executed. It's easy to construct simple VM networks.

Firstly, you must check whether the CPU on your machine is capable of launching VMs. If the returned value is not 0, your machine is ready to execute KVM.
 # cat /proc/cpuinfo | grep -c vmx

Install KVM modules. For Ubuntu 16.04, 
 # apt-get install kvm virt-manager libvirt-bin bridge-utils
For Ubuntu 18.04,
 # apt-get install qemu-kvm libvirt0 libvirt-bin virt-manager libguestfs-tools

Check whether the KVM modules have been successfully installed.
 # lsmod | grep kvm

Confirm whether the virtual bridge interface 'virbr0' has been installed by typing the following command.
 $ ifconfig

Initially, 'virbr0' has the private IP address "192.168.122.1". You can see configuration of this device by 
 $ cat /etc/libvirt/qemu/networks/default.xml
 
This private network, whose IP is 192.168.122.0/24, is defined as control plane of VMs.

// You can change this value by changing



* Virtual Machine Manager [#oe977e46]
[[Virtual Machine Manager (virt-manager):https://virt-manager.org/]]

** data plane [#hdc751dd]
実験用ネットワーク（data plane）data.xmlを作成する

/etc/libvirt/qemu/networks/ 以下の default.xml をコピーして data.xml を作成

 # cp default.xml data.xml

ファイルを以下の通りに変更する。

+ default.xml
 <network> ... </network>

+ data.xml
 <network>
 ... </network>

data plane を構築

 # virsh net-define data.xml

ちゃんと構築できたかを確認

 # virsh net-list --all

defineが終わってからは、ネットワーク環境を編集するには通常のエディタではできず、編集用の以下のコマンドが必要。初めにどのエディタを利用するか聞かれるので、選択を間違わないように。

 # virsh net-edit data

設定したネットワークをenableする

 # virsh net-start data

次回以降、ネットワークが自動で立ち上がるように設定を自動化する。

 # virsh net-autostart data

定義したネットワーク構成を無くすためには、以下のコマンドを実行する。ただし、作成したdata.xmlファイルは削除されるので、要注意。

 *virsh net-undefine data.xml (completely removed)



** VM作成 [#mbf7af6d]
はじめに正しいformatのVMを作成するため、VM をクリエイトしてから、できたVMのネットワーク設定を変更する。

Download iso image from Ubuntu website

Click 'add new vm' button.

Browse the iso image.

mark '[x] open-ssh' with the 'space' button.

vmを作成するとhypervisor内に /etc/libvirt/quem/vm.xmlができる。ここにdataのインタフェースを追加する。

 # virsh edit vm.xml 
 # virsh edit vm
 <vm.xml>

注意としては、pciのslotを使用されていない番号に変更する。e.g. 0x08

VMを起動し、ifconfigでインタフェースが追加sれていることを確認

 $ ifconfig -a

Note: Ubuntu 18.04以降、ifupdown has been replaced by 'netplan', you need to install the following package.

 # apt install ifupdown

IPアドレスを割り当て、インタフェースをアップする
 # ifconfig ens8 192.168.100.1 up

Hypervisorからpingで疎通確認

 $ ping 192.168.100.1

ens8インタフェースのIPアドレス設定を自動化するため、/etc/netwok/interfaces に以下を追加する。

 auto ens8
 iface ens8 inet static
          address 192.168.0.2
          netmask 255.255.255.0

IP経路表にdefault routeを追加し、

 # sudo ip route add default via 192.168.122.254 dev ens3

DNS設定を /etc/resolv.conf に追加する。

 nameserver 192.168.122.254


SSHの公開鍵を登録。
 echo 

開発用ツールのインストール

 sudo apt-get install emacs gcc g++ make
 

** VMの複製 [#d0b99d8e]

１つvmができたら、あとはvirt-managerのclone機能を使ってvmを複製し、hostnameとIP アドレスを変更するだけ。
 /etc/hosts
 /etc/hostname
 /etc/network/interfaces

辺りを修正する。※ただしUbuntu 16.04以降、ネットワーク設定はnetplanが使用されるようになっているため、以下の設定情報にも要注意。
 /etc/netplan
